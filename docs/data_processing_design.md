## 数据预处理与特征工程设计

### 1. 流程概览
1. **数据加载**：
   - 从 `data/raw/source_data` 读取 LC、LP、LCIS 原始数据，统一编码为 UTF-8。
   - 对日期字段统一使用 `datetime64[ns]` 类型，保留原始字符串以便追溯（必要时写入 `data/interim/`）。
2. **标签生成**：
   - `step1`: 使用 LCIS 中 `标当前状态` 字段（将包含“逾期”视为逾期=1，已还清/正常为0）。
   - `step2`: 对未覆盖的标，使用 LP 期次规则：
     - 若 `还款状态` ∈ {1,2} 且 `还款日期 > 到期日期` ⇒ 逾期；
     - 若 `还款状态` ∈ {0,4} 且 `recorddate > 到期日期` ⇒ 逾期；
     - 状态 3（已提前结清）视为非逾期。
   - `step3`: 合并两个来源的标记，若冲突则以 LP 逻辑为准。
   - 输出 `labels.parquet`（包含 `ListingId` + label）至 `data/processed/`。
3. **数据清洗**：
   - **缺失处理**：分类特征以众数/“未知”填充，数值特征视情况采样填补或中位数填充；对无法填补的重要记录可剔除，并记录剔除比例。
   - **异常值处理**：
     - 年龄限定在 [18, 70]，超出区间的记录置为缺失后填补或剔除。
     - 金额字段采用对数变换前进行 Winsorize（如按 1%、99% 分位截断）。
   - **一致性检查**：
     - 验证 `借款金额` 与 LP 中应还本金总和的近似一致；
     - 校验 `借款期限` 与 LP 最大期数差异。
4. **特征构建**：
   - **基础特征**：直接使用 LC 字段，类别特征进行 One-Hot 或目标编码（考虑高基数情况下的频数编码）。
   - **统计衍生**：历史逾期率、还款能力指数、认证成功数量、借款金额/历史成功金额比值、总待还本金占比等。
   - **时间特征**：借款成功日期的年份、季度、月份、是否周末、距平台上线天数等。
   - **LP衍生**：
     - 统计期次层面的累计逾期天数（若可获取 `标当前逾期天数`）。
     - 构造按期还款率 = 已正常还款期数 / 借款期限。
5. **特征选择与缩放**：
   - 数值特征进行标准化/归一化（如 StandardScaler/MinMaxScaler）。
   - 类别特征编码后一并组装 Feature Matrix。
   - 采用皮尔逊相关、卡方检验、基于树模型的特征重要性筛选冗余特征。

### 2. 数据分层与存储
- **数据集划分**：按 ListingId 进行分层采样，构建 70% 训练、15% 验证、15% 测试集，保持标签分布一致。
- **输出文件**：
  - `data/processed/train.parquet`
  - `data/processed/valid.parquet`
  - `data/processed/test.parquet`
  - 每个文件包含特征列 + `label`。
- **中间输出**：清洗后的合并数据存入 `data/interim/loan_master.parquet`，便于复用。

### 3. 自动化流水线设计
- 在 `src/data/` 中实现数据处理模块，提供以下函数：
  - `load_raw_data()`：读取原始数据并完成基本类型转换。
  - `generate_labels()`：实现标签逻辑并返回 DataFrame。
  - `clean_features()`：执行缺失值、异常值处理。
  - `build_features()`：构造衍生特征并输出特征列表。
  - `split_datasets()`：进行数据集划分和文件写入。
- 在 `src/pipelines/prepare_data.py` 封装 CLI/脚本入口，参数化操作（如输出路径、抽样比例）。
- 使用 YAML/JSON 配置（存于 `configs/`），定义清洗规则、特征列表、标签策略版本号。

### 4. 质量控制与测试
- 编写单元测试（`tests/test_data_pipeline.py`）验证：
  - 标签生成逻辑在手工构造的小样本数据上符合预期。
  - 清洗后数值特征无 NaN，类别特征统一在允许值集合中。
  - 数据集划分后无 `ListingId` 重复跨集。
- 记录数据处理日志（结合 `loguru`），输出处理统计摘要至 `logs/`。

### 5. 后续迭代方向
- 引入宏观经济变量（放入 `data/external/`），扩展特征空间。
- 探索时间窗口特征（如在借款成功前 12 个月的历史表现）。
- 若样本不平衡显著，可在特征工程阶段输出权重或 SMOTE 采样后数据集供模型对比。

