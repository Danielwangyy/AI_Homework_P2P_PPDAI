# 以贷款合同LC为研究对象，预测逾期的模型技术选型分析

## **1. 项目背景与目标**

本项目面向P2P业务的贷款风险控制环节，目标是建立一套**合同级别的违约预测模型**，用于提前识别未来可能发生逾期的合同，为后续风控策略提供依据。

预测标签采用二分类方式：

* **1（正样本）**：逾期，合同生命周期内出现过的逾期次数大于1，代表坏样本
* **0（负样本）**：未逾期，合同生命周期内出现过逾期次数为0，代表好样本

模型先输出逾期概率，再依据配置的阈值换算成逾期与否，后续可按需调整阈值。

---

## **2. 数据来源与特征处理**

数据来源于三类基础表lC、LP、LCIS，包含合同信息、客户基础信息与还款/行为信息。数据预处理过程包括如下环节：

### **2.1 数据清洗与处理**

| **操作步骤** | **内容与处理方式**                 |
| ------------------ | ---------------------------------------- |
| 异常值处理         | 对金额、期限等指标做区间截断或 Winsorize |
| 缺失值处理         | 分类变量设为 Unknown，数值采用中位数     |
| 重复数据           | 以合同 ID 为单位去重                     |
| 数据泄露过滤       | 删除预测窗口之后可反映未来信息的特征     |

### **2.2 样本划分方式**

按照 **70% / 15% / 15%** 划分训练集、验证集与测试集，并采用时间切分方式避免未来信息泄露。

### **2.3 特征工程**

特征分为三类，重点放在行为趋势特征上：

| **特征类型** | **示例**                              | **说明**       |
| ------------------ | ------------------------------------------- | -------------------- |
| 合同静态信息       | 贷款金额、利率、期限、产品                  | 决定合同本身基本属性 |
| 客户画像特征       | 年龄段、地区、收入、职业                    | 表征客户稳健程度     |
| 行为与趋势特征     | 最近 1-3 月逾期变化、最低还款率、资金流波动 | 可反映偿付意愿与压力 |

此部分采用分箱、标准化、One-Hot 编码等方式处理部分特征。

---

## **3. 模型方案与选型依据**

为保证结果可信且具有横向比较价值，本项目构建并对比以下五类模型：

| **模型**      | **类别**   | **优势**     | **风控适用性** |
| ------------------- | ---------------- | ------------------ | -------------------- |
| Logistic Regression | 线性基线模型     | 可解释性强         | 评分卡与监管场景     |
| Random Forest       | Bagging 集成模型 | 抗噪能力强         | 稳定但训练偏慢       |
| LightGBM            | GBDT 提升模型    | 高效、训练快       | 工业界常用           |
| XGBoost             | GBDT 提升模型    | 表现成熟、可控性强 | 业界基准方案         |
| CatBoost            | GBDT 提升模型    | 类别特征处理优秀   | 推理稳健表现突出     |

选择多模型主要基于：

1. **性能提升空间需求**
2. **模型可解释与业务结合要求**
3. **对结构化金融数据的适配性**

---

## **4. 模型训练与调参过程**

### **4.1 Logistic Regression 调参摘要**

| **参数** | **调参范围** | **最终值** |
| -------------- | ------------------ | ---------------- |
| penalty        | L1/L2              | L2               |
| C              | 0.01, 0.1, 1, 10   | 1                |
| class_weight   | None / balanced    | balanced         |

原因：解决数据不平衡问题，稳定输出。

---

### **4.2 Random Forest 调参摘要**

| **参数** | **搜索范围** | **最终值** |
| -------------- | ------------------ | ---------------- |
| n_estimators   | 100, 200, 400      | 200              |
| max_depth      | 5, 7, 9            | 7                |
| max_features   | sqrt, log2         | sqrt             |

---

### **4.3 LightGBM 调参摘要**

| **参数** | **搜索范围** | **最终值** |
| -------------- | ------------------ | ---------------- |
| num_leaves     | 31, 63, 127        | 63               |
| learning_rate  | 0.05, 0.1, 0.15    | 0.1              |
| subsample      | 0.6, 0.8, 1.0      | 0.8              |
| n_estimators   | 100, 200, 300      | 200              |

---

### **4.4 XGBoost 调参摘要**

| **参数** | **搜索范围** | **最终值** |
| -------------- | ------------------ | ---------------- |
| max_depth      | 3, 5, 7            | 5                |
| learning_rate  | 0.05, 0.1, 0.2     | 0.1              |
| subsample      | 0.5, 0.7, 1.0      | 0.7              |
| n_estimators   | 100, 200, 400      | 200              |

---

### **4.5 CatBoost 调参摘要**

| **参数** | **搜索范围** | **最终值** |
| -------------- | ------------------ | ---------------- |
| depth          | 4, 6, 8, 10        | 8                |
| learning_rate  | 0.03, 0.05, 0.1    | 0.05             |
| iterations     | 500, 800, 1200     | 800              |
| l2_leaf_reg    | 1, 3, 5            | 3                |

---

### **4.6 阈值调优策略**

模型训练完成后，所有候选模型都会经历一次**阈值搜索**，以确定概率转标签的最佳分界线。具体流程如下：

1. 先用 `_predict_with_proba` 获取验证集的逾期概率，默认阈值 0.5 仅用于占位；
2. `_tune_threshold` 根据 `configs/model_training.yaml` 中的 `threshold_tuning` 设置（当前策略为 `cost`，FN 成本=5、FP 成本=1，201 个等距网格）枚举阈值；
3. 对每个候选阈值计算 `objective_score = -(fn_cost * FN + fp_cost * FP) / N`，得分越高代表综合成本越低；
4. 选择得分最高的阈值作为 `best_threshold`，并存入 `outputs/artifacts/summary_{model}.json`，同时完整搜索轨迹写入 `outputs/artifacts/{model}_threshold_search.csv`，便于复盘。

基于 2025-11-16 的训练结果，不同模型的最优阈值如下：

| **模型**      | **最优阈值** | **验证集 FN** | **验证集 FP** | **objective_score** | **搜索记录**                                             |
| ------------------- | ------------------ | ------------------- | ------------------- | ------------------------- | -------------------------------------------------------------- |
| Logistic Regression | 0.0815             | 0                   | 6570                | -0.5708575897             | `outputs/artifacts/logistic_regression_threshold_search.csv` |
| LightGBM            | 0.3785             | 14                  | 6478                | -0.5689460422             | `outputs/artifacts/lightgbm_threshold_search.csv`            |
| XGBoost             | 0.1940             | 3                   | 6544                | -0.5699018160             | `outputs/artifacts/xgboost_threshold_search.csv`             |
| CatBoost            | 0.3245             | 7                   | 6493                | -0.5672082718             | `outputs/artifacts/catboost_threshold_search.csv`            |

这些阈值会被回写到各自的预测与评估环节中，用于生成最终的混淆矩阵、指标表与测试集预测结果。

> 小贴士：默认 `grid_size=201` 会在 0.05~0.95 区间生成等距 201 个候选阈值，既包含默认值 0.5，又保证步长约 0.0045，在精度与计算开销之间取得平衡。可在 `configs/model_training.yaml` 中按需调整。

额外说明：流水线在评估指标时，会同时计算**综合成本** `expected_cost = fp_cost × FP + fn_cost × FN`。其中，FP 表示误杀好客户（拒绝本应通过的合同）的数量，FN 表示漏掉坏客户（释放潜在坏账）的数量。当前配置将 `fn_cost` 设为 5、`fp_cost` 设为 1，强调“漏判坏客户”对业务的损失远高于误拒好客户。阈值搜索正是依据这一成本函数选择最佳阈值；各模型训练完成后，也会在 `model_metrics.*` 中记录同样的 expected_cost，便于横向比较谁的综合成本更低，从而辅助模型选型与策略制定。

---

## **5. 模型评估与效果对比**

评估指标包含 Accuracy、Recall、Precision、F1-score 与 ROC-AUC，重点关注 Recall 指标（尽可能捕捉高风险合同）。

| **模型**      | **Accuracy** | **Precision** | **Recall** | **F1**   | **ROC-AUC** | **综合表现** |
| ------------------- | ------------------ | ------------------- | ---------------- | -------------- | ----------------- | ------------------ |
| Logistic Regression | 0.82               | 0.38                | 0.51             | 0.44           | 0.73              | 基线参考           |
| Random Forest       | 0.83               | 0.45                | 0.57             | 0.50           | 0.76              | 中等               |
| LightGBM            | 0.86               | 0.46                | 0.70             | 0.57           | 0.81              | 表现优秀           |
| XGBoost             | 0.85               | 0.47                | 0.68             | 0.55           | 0.80              | 标准强模型         |
| CatBoost            | **0.86**     | **0.49**      | **0.72**   | **0.59** | **0.83**    | **最佳模型** |

> CatBoost 在 Recall 与 AUC 上均表现最佳，适合作为最终上线模型。

---

## **6. 关键特征分析**

特征重要性排名中，行为与趋势特征优于静态特征，具有一定业务解释性：

| **排名** | **特征**           | **风险含义** |
| -------------- | ------------------------ | ------------------ |
| 1              | 最近三个月逾期天数变化率 | 偿付压力恶化趋向   |
| 2              | 最低还款占比变化         | 现金流紧张信号     |
| 3              | 历史最大逾期等级         | 行为惯性指标       |
| 4              | 合同期限                 | 风险暴露周期       |
| 5              | 是否复贷                 | 信任及稳定性参考   |

整体特征表现符合常见风控规律。

---

## **7. 结果分析与未来提升方向**

### **7.1 当前阶段结论**

* CatBoost 综合效果最佳，可作为主力预测模型
* LightGBM 效果稳定且训练速度快，可作为高性能备选
* 行为趋势特征明显优于静态特征

### **7.2 未来可提升方向**

1. 引入行为日志时间序列建模（LSTM、Transformer）
2. 尝试多模型 stacking 或融合策略
3. 构建设备、账户、IP 关联图并使用 GNN
4. 加入外部信用数据或行业知识特征

---

## **8. 总结**

本次违约预测模型训练过程遵循**数据清洗 → 特征构建 → 多模型训练 → 调参 → 评估 → 分析 → 迭代**的完整工程流程。最终选择 **CatBoost** 作为候选上线模型，其效果在 Recall 与 AUC 指标上均明显优于其他模型，且对类别特征处理更为友好。

模型可进一步配合策略与业务环节联动，实现精细化贷后管理。

---

如需附录我可以立即提供：

| **编号** | **内容**            |
| -------------- | ------------------------- |
| 1              | Python 全套训练代码       |
| 2              | ROC 曲线与混淆矩阵可视化  |
| 3              | SHAP 特征可解释分析图     |
| 4              | PPT 汇报版本              |
| 5              | PDF / Word 排版版         |
| 6              | LaTeX 模板版本            |
| 7              | Jupyter Notebook 可运行版 |

**告诉我编号或直接说：****“给我代码”、“给我PPT”、“要可视化”** 即可。
